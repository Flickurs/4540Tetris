<!DOCTYPE HTML>
<html>
<head>
    <meta content="text/html;charset=utf-8" http-equiv="Content-Type"/>
    <meta content="utf-8" http-equiv="encoding"/>
    <title>Tetris Example </title>

    <!-- THIS FIRST -->
    <script src="jquery-1.11.2.min.js"></script> <!-- 1 - JQUERY -->
    <script src="Pixi/pixi.js"></script>

</head>

<body>

  <div class="c4"> </div>

<script>
	"use strict";
	var Polyominos = {
		STRAIT: 0,
		SQUARE: 1,
		T: 2,
		J: 3,
		L: 4,
		S: 5,
		Z: 6
	};
	var color_array = [0xff0000, 0x00ff00, 0x0000ff];
	var color_index = 0;
	class Piece {
	    constructor(north, south, west, east) {
	        this.i = 4;
	        this.j = 0;
	        this.north = north;
	        this.south = south;
	        this.west = west;
	        this.east = east;
	    }
	    down() {
	        this.j++
	    }
	    up() {
	        this.j--
	    }
	    left() {
	        this.i--;
	        if (this.i - this.west < 0) {
	            this.i = 0 + this.west;
	        }
	    }
	    right() {
	        this.i++;
	        if ((this.i + this.east) > 9) {
	            this.i = 9 - this.east ;
	        }
	    }

	    rotate()
	    {
	    	if(this.east + this.west == this.south + this.north) {
	    		return;
	    	}
	    	var temp = this.north;
	    	this.north = this.east;
	    	this.east = this.south;
	    	this.south = this.west;
	    	this.west = temp;
	    	for (var i = 0; i < this.values.length; i++) {
	    		var temp = this.values[i][0];
	    		this.values[i][0] = this.values[i][1];
	    		this.values[i][1] = temp*(-1);
	    	}
	    	if ((this.i + this.east) > 9)
	    		this.i = 9 - this.east;
	    	else if ((this.i - this.west) < 0)
	    		this.i = 0 + this.west;
	    	else if ((this.j - this.north) < 0)
	    		this.j = 0 + this.north;
	    	else if ((this.j + this.south) > 19)
	    		this.j = 19 - this.south;
	    }

	    draw(matrix) {
	        for (var i = 0; i < this.values.length; i++) {
	            var cell = matrix[this.i + this.values[i][0]][this.j + this.values[i][1]];
	            cell.visible = true;
	            cell.color = this.color;
	            cell.draw()
	        }
	    }
	    fill(matrix, row_count) {
	        for (var i = 0; i < this.values.length; i++) {
	        	row_count[(this.j + this.values[i][1])]++;
	            var cell = matrix[this.i + this.values[i][0]][this.j + this.values[i][1]];
	            cell.visible = true;
	            cell.color = this.color;
	            cell.filled = true;
	            cell.draw()
	        }
	    }
	    conflict(matrix) {
	        for (var i = 0; i < this.values.length; i++) {
	            var i_offset = this.i + this.values[i][0];
	            var j_offset = this.j + this.values[i][1];
	            if (j_offset >= 20)
	            	return true;
	            var cell = matrix[i_offset][j_offset];
	            console.log(cell);
	            if (cell.filled)
	            	return true;
	        }
	        return false
	    }
	}

	class Square_Polyomino extends Piece {
		constructor() {
			super(0, 1, 0, 1);
			this.color = 0xffcc00;
			this.values = [
	                [0, 0],
	                [0, 1],
	                [1, 0],
	                [1, 1]
	            ];
		}
	}

	class Straight_Polyomino extends Piece {
		constructor() {
			super(0, 0, 1, 2);
			this.values = [
				[-1, 0],
				[0, 0],
				[1, 0],
				[2, 0]
			];
			this.color = 0x06eff2;
		}
	}

	class T_Polyomino extends Piece {
		constructor() {
			super(0, 1, 1, 1);
			this.values = [
	                [-1, 0],
	                [0, 0],
	                [0, 1],
	                [1, 0]
	            ];
	        this.color = 0xff02ff;
		}
	}

	class J_Polyomino extends Piece {
		constructor() {
			super(0, 1, 1, 1);
			this.values = [
	                [-1, 0],
	                [0, 0],
	                [1, 0],
	                [1, 1]
	            ];
	        this.color = 0x0000ff;
		}
	}

	class L_Polyomino extends Piece {
		constructor() {
			super(0, 1, 1, 1);
			this.values = [
				[-1, 0],
				[-1, 1],
				[0, 0],
				[1, 0]
			];
			this.color = 0xff8001;
		}
	}

	class S_Polyomino extends Piece {
		constructor() {
			super(0, 1, 1, 1);
			this.values = [
				[-1, 1],
				[0, 0],
				[0, 1],
				[1, 0]
			];
			this.color = 0x00ff01;
		}
	}

	class Z_Polyomino extends Piece {
		constructor() {
			super(0, 1, 1, 1);
			this.values = [
				[-1, 0],
				[0, 0],
				[0, 1],
				[1, 1]
			];
			this.color = 0xff0000;
		}
	}

	class Cell {
	    constructor(container, i, j) {
	        this.square = new PIXI.Graphics();
	        container.addChild(this.square);
	        this.square.x = i * 25;
	        this.square.y = j * 25;
	        this.square.mouseover = function() {
	            console.log("mouse over")
	        };
	        this.filled = false;
	        this.color = 0xffffff
	    }
	    draw() {
	        this.square.clear();
	        this.square.beginFill(this.color);
	        this.square.lineStyle(1, 0xFFFFFF);
	        this.square.drawRect(0, 0, 25, 25);
	        this.square.endFill()
	    }
	    set visible(value) {
	        this.square.visible = value
	    }
	}
	class Tetris {
	    constructor(stage) {
	        console.log("constructor for tetris");
	        this.board = new PIXI.Sprite();
	        this.outline = new PIXI.Graphics();
	        this.board.x = 50;
	        this.board.y = 50;
	        this.draw_outline();
	        this.board.addChild(this.outline);
	        this.build_matrix(this.board);
			this.board_row_count = [];
			for (var i = 0; i < 20; i++)
				this.board_row_count[i] = 0;
	        stage.addChild(this.board);
	        this.random_piece();
	        this.draw_piece();
	        document.addEventListener('keydown', this.handle_key_presses.bind(this));
	        this.start_game_loop();
	    }

	    start_game_loop() {
	    	setInterval(this.tick.bind(this), 1000);
	    }

	    tick() {
	    	this.current_piece.down();
            if (this.current_piece.conflict(this.board_matrix)) {
                this.current_piece.up();
                this.current_piece.fill(this.board_matrix);
                this.random_piece();
                this.draw_piece();
            }
	        this.clear_board();
	        this.draw_piece()
	    }

	    random_piece(){
	    	var random = Math.floor(Math.random() * 7);
	    	switch(random){
	    		case Polyominos.STRAIT:
	    			this.current_piece = new Straight_Polyomino();
	    			break;
	    		case Polyominos.SQUARE:
	    			this.current_piece = new Square_Polyomino();
	    			break;
	    		case Polyominos.T:
	    			this.current_piece = new T_Polyomino();
	    			break;
	    		case Polyominos.J:
	    			this.current_piece = new J_Polyomino();
	    			break;
	    		case Polyominos.L:
	    			this.current_piece = new L_Polyomino();
	    			break;
	    		case Polyominos.S:
	    			this.current_piece = new S_Polyomino();
	    			break;
	    		case Polyominos.Z:
	    			this.current_piece = new Z_Polyomino();
	    			break;
	    	}
	    }

	    handle_key_presses(key) {
	        if (key.code == "ArrowDown") {
	            this.current_piece.down();
	            if (this.current_piece.conflict(this.board_matrix)) {
	                this.current_piece.up();
	                this.current_piece.fill(this.board_matrix, this.board_row_count);
	                this.random_piece();
	                this.draw_piece()
	            }
	        }
	        if (key.code == "ArrowLeft") {
	            this.current_piece.left();
	            if (this.current_piece.conflict(this.board_matrix)) {
	                this.current_piece.right()
	            }
	        }
	        if (key.code == "ArrowRight") {
	            this.current_piece.right();
	            if (this.current_piece.conflict(this.board_matrix)) {
	                this.current_piece.left()
	            }
	        }
	        if (key.keyCode == 32) {
	        	this.current_piece.rotate();
	        }
	        this.clear_board();
	        this.draw_piece()
	    }
	    draw_piece() {
	        this.current_piece.draw(this.board_matrix)
	    }
	    build_matrix(container) {
	        this.board_matrix = [];
	        for (var i = 0; i < 10; i++) {
	            this.board_matrix[i] = [];
	            for (var j = 0; j < 20; j++) {
	                this.board_matrix[i][j] = new Cell(container, i, j);
	                this.board_matrix[i][j].visible = false
	            }
	        }
	    }
	    clear_board() {
	        for (var i = 0; i < 10; i++) {
	            for (var j = 0; j < 20; j++) {
	                this.board_matrix[i][j].draw();
	                if (this.board_matrix[i][j].filled) {
	                    this.board_matrix[i][j].visible = true
	                } else {
	                    this.board_matrix[i][j].visible = false
	                }
	            }
	        }
	    }
	    draw_outline() {
	        this.outline.clear();
	        this.outline.lineStyle(2, 0xCCCCCC);
	        this.outline.beginFill();
	        this.outline.drawRect(0, 0, 250, 500);
	        this.outline.endFill()
	    }
	}
	var stage;
	var renderer;

	function doit() {
	    $("body").append("hello")
	}

	function after_load() {
	    stage = new PIXI.Container();
	    stage.interactive = true;
	    renderer = PIXI.autoDetectRenderer(350, 620, null);
	    document.body.appendChild(renderer.view);
	    requestAnimationFrame(animate);
		new Tetris(stage)
	}

	function animate() {
	    requestAnimationFrame(animate);
	    renderer.render(stage)
	}
	after_load();
</script>

</body>

</html>